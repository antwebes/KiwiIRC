<style>
    .r {
        font-weight: bold;
    }
</style>

<script>
    kiwi.plugins.on('loaded', function(){

        var users = {};

        var realtimeEndpoint = kiwi.settings.get('realtime_api_endpoint');

        /**
         * Get users connected to a channel
         * @var channel
         * @var page
         * @return jQuery.Deferred
         */
        var getRemoteUsersOfChannel = function(channel, page){
            return jQuery.ajax({
                url: realtimeEndpoint + '/user_channels',
                data: {
                    _format: 'json',
                    name: channel,
                    page: page
                }
            });
        };

        /**
         * Gets a deferred of users of a given channel
         * @var channel
         * @return jQuery.Deferred
         */       
        var channelUsers = function(channel){
            var users = [];
            var usersDeferred = jQuery.Deferred();
            var currentPage = 1;

            // handles the data retreived from the server. The handler makes the decission to resolve the deferred or get more pages
            var handleData = function(data){
                var total = data["hydra:totalItems"];
                var itemsPerPage = data["hydra:itemsPerPage"];
                var id = data["@id"];
                var lastPage = data["hydra:lastPage"];
                

                if(typeof(data['hydra:member']) != 'undefined'){
                    _.map(data['hydra:member'], function(user){
                        users.push(user);
                    });
                    
                    if(id != lastPage){ // we have to fetch more pages
                        currentPage++;
                        getRemoteUsersOfChannel(channel, currentPage)
                            .then(handleData)
                            .fail(function(){
                                usersDeferred.reject();
                            });
                    }else{
                        usersDeferred.resolve(users); //we have all data, let's resolve
                    }
                }else{
                    // no users so we resolve with empty data
                    usersDeferred.resolve(users);
                }
            };

            // begin to get data from the first page
            getRemoteUsersOfChannel(channel, currentPage)
               .then(handleData)
               .fail(function(){
                    usersDeferred.reject();
               });

            return usersDeferred;
        };

        /**
         * Returns a deferred for the data of the user or create one
         * @var nick
         * @return jQuery.Deferred
         */
        var getOrCreateDeferredForNickData = function(nick){
            if(typeof(users[nick]) == 'undefined'){
                var promise = jQuery.Deferred();
                users[nick] = promise;
            }

            return users[nick];
        };

        /**
         * Resolves the deferred corresponding to the userData given
         * @var userData
         */
        var resolveUserDeferred = function(userData){
            var user = userData.user;
            var userDataDeferred = getOrCreateDeferredForNickData(user.nick);

            // only resolve if not allready resolved
            if(userDataDeferred.state() == 'pending'){
                userDataDeferred.resolve(user);
            }
        };

        /**
         * Resolves all user deferreds associated to the given users
         */
        var populateUsersDeferredData = function(usersData){
            _.map(usersData, resolveUserDeferred);
        };


        // when a panel is created a it is a chaNNEL, we fetch users from realtime
        kiwi.events.on('panel:created', function(event, data){
            var panel = data.panel;

            /**
             * function that adds register mode to member if he is registered
             */
            var addRegisterMode = function(member){
                var nick = member.get('nick');
                var userDataDeferred = getOrCreateDeferredForNickData(nick);

                userDataDeferred.then(function(userData){
                    if(userData.register){
                        member.addMode('r');
                    }
                });
            };

            if(panel.isChannel()){
                var channel = panel.get('name');
                var memberList = panel.get('members');

                panel.get('members').bind('add', addRegisterMode);

                panel.get('members').bind('reset', function(members){
                    members.forEach(addRegisterMode);
                });

                panel.on('active', function(){
                    panel.get('members').forEach(addRegisterMode);
                });

                // start fetching data
                channelUsers(channel).then(populateUsersDeferredData);

                // refresh data for the channel every 2 minutes
                var intervalTimer = setInterval(function(){
                    channelUsers(channel).then(populateUsersDeferredData);
                }, 120000);

                (function(panel, intervalTimer){ // wrap in anonymous function to avoid loosing intervalTimer reference
                    panel.bind('remove', function(){
                        clearInterval(intervalTimer);
                    });
                })(panel, intervalTimer);
            }
        });
    });
</script>