<style>
    .registered {
        font-weight: bold;
    }
</style>

<script>
    kiwi.plugins.on('loaded', function(){

        var users = {};

        var realtimeEndpoint = "http://127.0.0.1:8000/app_dev.php";

        var originalMemberRender = _kiwi.view.Member.prototype.render;
        var originalMemberListInitialize = _kiwi.model.MemberList.prototype.initialize;

        var getRemoteUsersOfChannel = function(channel, page){
            return jQuery.ajax({
                url: realtimeEndpoint + '/user_channels',
                data: {
                    _format: 'json',
                    name: channel,
                    page: page
                }
            });
        };

        var channelUsers = function(channel){
            var users = [];
            var usersDeferred = jQuery.Deferred();
            var currentPage = 1;

            var handleData = function(data){
                var total = data["hydra:totalItems"];
                var itemsPerPage = data["hydra:itemsPerPage"];
                var id = data["@id"];
                var lastPage = data["hydra:lastPage"];
                

                if(typeof(data['hydra:member']) != 'undefined'){
                    _.map(data['hydra:member'], function(user){
                        users.push(user);
                    });
                    
                    if(id != lastPage){
                        currentPage++;
                        getRemoteUsersOfChannel(channel, currentPage).then(handleData);
                    }else{
                        usersDeferred.resolve(users);
                    }
                }
            };

            getRemoteUsersOfChannel(channel, currentPage).then(handleData);

            return usersDeferred;
        };

        var getOrCreateDeferredForNickData = function(nick){
            if(typeof(users[nick]) == 'undefined'){
                var promise = jQuery.Deferred();
                users[nick] = promise;
            }

            return users[nick];
        };

        var resolveUserDeffered = function(userData){
            var user = userData.user;
            var userDataDeferred = getOrCreateDeferredForNickData(user.nick);

            if(userDataDeferred.state() == 'pending'){
                userDataDeferred.resolve(user);
            }
        };

        var populateUsersDeferredData = function(data){
            _.map(data, resolveUserDeffered);
        };

        _kiwi.view.Member.prototype.render = function(){
            var $this = this.$el;
            var nick = this.model.get('nick');
            var userDataDeferred = getOrCreateDeferredForNickData(nick);
            
            originalMemberRender.call(this);

            userDataDeferred.then(function(userData){
                if(userData.register){
                    $this.addClass('registered');
                }
            });
                
            return this;
        };


        // when a panel is created, we fetch user from realtime
        kiwi.events.on('panel:created', function(event, data){
            var panel = data.panel;

            if(panel.isChannel()){
                var channel = panel.get('name');
                channelUsers(channel).then(populateUsersDeferredData);
            }
        });
    });
</script>