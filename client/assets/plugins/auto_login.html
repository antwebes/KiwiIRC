<script type="text/javascript">
    (function(){

        function getToken() {
            var token = '';
            if(typeof window.token == 'undefined'){
                if (getQueryVariable('token') =='undefined'){
                    return;
                }else{
                    token = getQueryVariable('token');
                }
            }else{
                token = window.token;
            }
            return token;
        }

        kiwi.events.on('loaded', function(){
            var network = kiwi.components.Network();
            var input = kiwi.components.ControlInput();


            network.on('message:notice', function(event) {
                var token = getToken();

                if(event.nick.toLowerCase() == 'nickserv' || event.nick.toLowerCase() == 'nick') {
                    if(
                            event.msg.indexOf("nickname is registered and protected.")  > -1 ||
                            event.msg.indexOf("nick está registrado y protegido.")  > -1
                    ){
                        network.msg(event.nick, 'identifyoauth '+token);
                    }
                    console.log(event);
                }
            });


            network.on('message:message', function(event) {

                var token = getToken();
                
                if(event.nick.toLowerCase() == 'nickserv' || event.nick.toLowerCase() == 'nick') {
                    if(
                            event.msg.indexOf("nickname is registered and protected.")  > -1 ||
                            event.msg.indexOf("nick está registrado y protegido.")  > -1
                    ){
                        network.msg(event.nick, 'identifyoauth '+token);
                    }
                }
            });

            if (getQueryVariable('nick')) {
                var nick = getQueryVariable('nick');

                $('#server_select_nick').val(nick);
            }


            var channelStr = getQueryVariable('channel') || getQueryVariable('channels');
            if (channelStr) {
                var channels = channelStr.split(',');
                channels = channels.map(function (channel) {
		    channel = channel.replace("%2523","#");
                    channel = channel.replace("%23","#");

                    return channel;
                });

                $('.server_select').hide();
                $('#server_select_channel').val(channels.join(','));
            }

            if (getQueryVariable('private')) {
                var private = getQueryVariable('private');

                $('.server_select').hide();

                network.on('connect', function () {
                    input.run('/query ' + private);

                    //To show panel active chat room chatsfree
                    if (kiwi.connections.active_connection.panels.getByName('#chatsfree')) {
                        kiwi.connections.active_connection.panels.getByName('#chatsfree').view.show()
                    } else {
                        kiwi.connections.active_connection.panels.find(function (panel) {
                            return panel.isChannel();
                        }).view.show();
                    }
                });
            }

            var auto_connect = getQueryVariable('auto_connect');

            network.on('connect', function(event) {
                if(getQueryVariable('nick') && getQueryVariable('nick') == getQueryVariable('token_nick')) {
                    var token = getToken();
                    network.msg("NiCK", 'identifyoauth '+token);
                } 
            });

            if (typeof auto_connect == 'undefined' || auto_connect =='true') {
                $('[data-js=submit]').click();
            }
        });
    })();
</script>
