<script type="text/javascript">

    kiwi.plugins.on('loaded', function(){


		$(".main").append($('<li class="right-menu-btn"><i class="fa fa-gear" title="Open Menu"></i></li>'));


    	

    	window.update_right_menu = function () {
    		var items = window.right_menu_items || [];
    		var itemsLength = items.length;

    		$(".right-menu").remove();

			$(".main").append($( "<div class='right-menu'><ul class='right-menu-items'></ul></div>"));



			$(".right-menu-btn").click(function () {
				$('.right-menu').mmenu().trigger( "open.mm" );
			});

    		

			for (var i = 0; i < itemsLength; i++) {
				$(".right-menu-items").append(generateRightMenuItem(items[i]));
			}

			$('.right-menu').mmenu({
			   counters	: true,
			   searchfield	: true,
			   "offCanvas": {
			      "position": "right"
			   }
	        }).on("click", "a[href=\"#\"]",
				function(event) {
					if(event.target.innerText != undefined) {
						 if(typeof ga !== 'undefined') ga('send', 'event', 'right_menu', event.target.innerText);
					}
					return true;
				}
			);
    	}

    	generateToggle=  function(item) {
    		var toggle= '<input type="checkbox" data-name="'+item.name+'"';
    		if(item.options) {
    			
    			if(item.options.className) {
					toggle += " " + item.opotion.className + '"';
    			}  else {
    				toggle += 'class="Toggle"';
    			} 	

    			if(item.options.defaultValue) {
    				toggle += 'checked';
    			}
    			if(item.options.groupName) {
    				toggle += 'data-groupName="'+item.options.groupName+'"';
    			}
    		} else {
    			toggle += 'class="Toggle"';
    		}
    		toggle += '/>';   	
    		return toggle;	
    	}
		
		generateRightMenuItem = function(item) {
			if(item.submenu == undefined && item.type != "Toggle" && item.type != "Slider"){
				var itemStr = '<li><a href="#"><i class="fa fa-'+item.icon+'"></i> ' + item.name + '</a></li>';
			} else {
				var itemStr = '<li><span><i class="fa fa-'+item.icon+'"></i> ' + item.name + '</span></li>';
			}

			var $itemMenu = $(itemStr);
			var $clickItem = $itemMenu;



			switch(item.type){
				case "Toggle":
					$itemMenu.append(generateToggle(item));
					$clickItem = $("input", $itemMenu);
					if(item.options && item.options.groupName) {
						$clickItem.click(function () {

							$(document).find("*[data-groupName='" + item.options.groupName + "']").each(function( index ) {
								if($(this).data("name") != item.name) {
									$(this).prop( "checked", false );
								}
							});
						});
					}
				break;
				case "Slider":
					window.loadExternalLib(jQuery.ui, ["//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css", "//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"], function() {
						$( "span" ,$itemMenu).append('<div id="slider"></div>');
						$( "#slider", $itemMenu ).slider({
							min: 0,
							step: 0.01,
							max: 1,
							value: item.options.defaultValue
						});
					});
				break;

			}

			if(item.command != undefined) {
				var eventName= "click";
				if(item.options) {
					eventName =	item.options.event || "click";
				} 
				console.log("handle event", eventName);
				$clickItem.on(eventName, function () {
					console.log("eventico");
					var input = kiwi.components.ControlInput();
					switch(item.type) {
						case "Toggle":
							input.run(item.command + " " + $("input", $itemMenu).is(':checked'));
						break;
						case "Slider":
							input.run(item.command + " " + $("#slider", $itemMenu).slider( "option", "value" ));
						break;
						default:
							input.run(item.command);
						break;
					}

	            	
	            	$('.right-menu').mmenu().trigger("close.mm");
				});				
			}


			if(item.submenu != undefined){
				$itemMenu.append("<ul />");
				var itemsSubmenuLength = item.submenu.length;
				for (var i = 0; i < itemsSubmenuLength; i++) {
		 			$("ul", $itemMenu).append(generateRightMenuItem(item.submenu[i]));
				}

			}


			return $itemMenu;
		}


		window.update_right_menu();

    });
</script>

