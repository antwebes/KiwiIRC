<script type="text/javascript">

	kiwi.plugins.on('loaded', function(){

		var translate = function(msgid){
			return kiwi.i18n.translate(msgid).fetch();
		};


		$(".main").append($('<li class="right-menu-btn"><i class="fa fa-gear" title="Open Menu"></i></li>'));


		window.create_right_menu = function (items) {
			var itemsLength = items.length;

			$('.right-menu').mmenu().trigger("close.mm");
			$(".right-menu").remove();

			$(".main").append($( "<nav class='right-menu'><ul class='right-menu-items'></ul></nav>"));



			$(".right-menu-btn").click(function () {
				$('.right-menu').mmenu().trigger( "open.mm" );
			});



			for (var i = 0; i < itemsLength; i++) {
				$(".right-menu-items").append(generateRightMenuItem(items[i]));
			}

			$('.right-menu').mmenu({
				counters	: true,
				searchfield	: true,
				"offCanvas": {
					"position": "right"
				}
			}).on("opened.mm", function () {
				console.log("opened");
				$( '.right-menu a' ).addClass( "no_navigate" );
			})
					.on("click", "a[href=\"#\"]",
					function(event) {
						if(event.target.innerText != undefined) {
							if(typeof ga !== 'undefined') ga('send', 'event', 'right_menu', event.target.innerText);
						}
						return true;
					}
			);
		}

		window.right_menu_items = [
			{
				"name": translate('plugin_right_menu_avatar'),
				"icon": "users",
				"command": "/avatar"
			},
			{
				"name": translate('plugin_right_menu_list_channels'),
				"icon": "comments",
				"command": "/list"
			},
			{
				"name": translate('plugin_right_menu_find_people'),
				"icon": "search",
				"command": "/findpeople"
			},
			{
				"name": translate('plugin_right_menu_away'),
				"icon": "clock-o",
				"command": "/showaway"
			},
			{
				"name": translate('plugin_right_menu_history'),
				"icon": "history",
				"submenu": [

				]
			},
			{
				"name": translate('plugin_right_menu_radio'),
				"icon": "headphones",
				"submenu": [

				]
			},
			{
				"name": translate('plugin_right_menu_settings'),
				"icon": "cogs",
				"command": "/settings"
			},
			{
				"name": translate('plugin_right_menu_help'),
				"icon": "info-circle",
				"submenu":[
					{
						"name": translate('plugin_right_menu_help_web'),
						"icon": "info",
						"link": {
							"href": "https://www.chatsfree.net/static/help",
							"target": "blank"
						}
					},
					{
						"name": translate('plugin_right_menu_help_irc'),
						"icon": "info",
						"command": "/join #help"
					}
				]
			}
		];

		// now that the menus are configured, we inform the promise that is done
		window.right_menu_items_deferred.resolve();

		generateToggle=  function(item) {
			var toggle= '<input type="checkbox" data-name="'+item.name+'"';
			if(item.options) {

				if(item.options.className) {
					toggle += " " + item.opotion.className + '"';
				}  else {
					toggle += 'class="Toggle"';
				}

				if(item.options.defaultValue) {
					toggle += 'checked';
				}
				if(item.options.groupName) {
					toggle += 'data-groupName="'+item.options.groupName+'"';
				}
			} else {
				toggle += 'class="Toggle"';
			}
			toggle += '/>';
			return toggle;
		}

		generateRightMenuItem = function(item) {
			var linkAttributes = function(attributes){
				var attributesString = '';

				for(attribute in attributes){
					attributesString += ' '+attribute+'="'+attributes[attribute]+'"';
				}

				return attributesString;
			};

			if(item.link == undefined){
				var itemStr = '<li><span><i class="fa fa-'+item.icon+'"></i> ' + item.name + '</span></li>';
			}else{
				var itemStr = '<li><a class="right-menu-external-link" '+linkAttributes(item.link)+'><i class="fa fa-'+item.icon+'"></i> ' + item.name + '</a></li>';
			}

			var $itemMenu = $(itemStr);
			var $clickItem = $itemMenu;



			switch(item.type){
				case "Toggle":
					$itemMenu.append(generateToggle(item));
					$clickItem = $("input", $itemMenu);
					if(item.options && item.options.groupName) {
						$clickItem.click(function () {

							$(document).find("*[data-groupName='" + item.options.groupName + "']").each(function( index ) {
								if($(this).data("name") != item.name) {
									$(this).prop( "checked", false );
								}
							});
						});
					}
					break;
				case "Slider":
					window.loadExternalLib(jQuery.ui, ["//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css", "//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js"], function() {
						$( "span" ,$itemMenu).append('<div id="slider"></div>');
						$( "#slider", $itemMenu ).slider({
							min: 0,
							step: 0.01,
							max: 1,
							value: item.options.defaultValue
						});
					});
					break;

			}

			if(item.command != undefined) {
				var eventName= "click";
				if(item.options) {
					eventName =	item.options.event || "click";
				}
				$clickItem.on(eventName, function () {
					var input = kiwi.components.ControlInput();
					switch(item.type) {
						case "Toggle":
							input.run(item.command + " " + $("input", $itemMenu).is(':checked'));
							break;
						case "Slider":
							input.run(item.command + " " + $("#slider", $itemMenu).slider( "option", "value" ));
							break;
						default:
							input.run(item.command);
							break;
					}


					$('.right-menu').mmenu().trigger("close.mm");
				});
			}


			if(item.submenu != undefined){
				$itemMenu.append("<ul />");
				var itemsSubmenuLength = item.submenu.length;
				for (var i = 0; i < itemsSubmenuLength; i++) {
					$("ul", $itemMenu).append(generateRightMenuItem(item.submenu[i]));
				}

			}


			return $itemMenu;
		}


		// this promise is resolved outside this plugins, so, the app could load move items
		// once the promise is resolved, then whe render the items
		window.menu_items_ready_promise.then(function(items){
			window.create_right_menu(window.right_menu_items);
		});

	});
</script>