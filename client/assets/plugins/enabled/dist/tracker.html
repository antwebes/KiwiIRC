

    var contMsgPrivate = 0;
    var contMsgRooms = 0;

    var arrPrivate = [];
    var arrRooms = [];

    var connected = false;

    var start = Date.now();

    kiwi.plugins.on('loaded', function(){
        var input = kiwi.components.ControlInput();
        connected = true;

        input.on('command:msg', function(event) { 
            var activeContainer = kiwi.panels().active.get("name");
            if(activeContainer.indexOf("#") == 0){
                if(arrRooms.indexOf(activeContainer) == -1) arrRooms.push(activeContainer);
                contMsgRooms++;
            } else {
                if(arrPrivate.indexOf(activeContainer) == -1) arrPrivate.push(activeContainer);
                contMsgPrivate++;
            }

        });
    });


    window.onbeforeunload = function (e) {
        var end = Date.now();
        var time = Math.round((end - start) / 1000);

        var mynick = kiwi.connections.getByConnectionId(0).get('nick');

        ga('send', "event", "ChatMessages", mynick,
            {
              'dimension3':  mynick,
              'metric1': contMsgPrivate,
              'metric2': contMsgRooms,
              'metric3': arrPrivate.length,
              'metric4': arrRooms.length,
              'metric5': time
            }
        );

        ga('send', 'event', 'ChatChannels', arrRooms.join());

        contMsgPrivate = 0;
        contMsgRooms = 0;
        arrPrivate = [];
        arrRooms = [];
        time = 0;


        if (connected) {
            return "This will close all conversations. Are you sure you want to close this window and exit of chat?";
        }
    };

