<script type="text/javascript">
    
    kiwi.plugins.on('loaded', function(){


		function onJqueryUILoaded(callback){
		     if(typeof jQuery.ui == 'undefined') {
		                 var headTag = document.getElementsByTagName("head")[0];
		                 var jqTag = document.createElement('script');
		                 jqTag.type = 'text/javascript';
		                 jqTag.src = '//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js';
		                 jqTag.onload = callback;
		                var jqlinkTag = document.createElement('link');
		                jqlinkTag.rel = 'stylesheet';
		                jqlinkTag.href = '//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css';
		                jqlinkTag.onload = function(){
		                    headTag.appendChild(jqTag);
		                }
		                headTag.appendChild(jqlinkTag);
		     } else {
		                 callback();
		     }
		}

		function onSwfobjectLoaded(callback){
		     if(typeof swfobject == 'undefined') {
		                 var headTag = document.getElementsByTagName("head")[0];
		                 var jqTag = document.createElement('script');
		                 jqTag.type = 'text/javascript';
		                 jqTag.src = '//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js';
		                 jqTag.onload = callback;
		                 headTag.appendChild(jqTag);
		     } else {
		                 callback();
		     }
		}


		onSwfobjectLoaded(function () {
		onJqueryUILoaded(function () {

			

			var $webcam;
			var active = false;

			function openWebcam(nick){
				$("#webcam_container").append($("<div />", {id: "webcam_subscriber_container"}));
				$("#webcam_subscriber_container").append($("<div />", {id: "flash_webcham_subs"}));

				active = true;

				var params = {};
	            var flashVars = {
	                streamer: 'rtmp://webcam.chatsfree.net:1935/videochat'
	            };

	            flashVars.file = nick;
	            
	            params.allowfullscreen = "true";


	            swfobject.embedSWF("http://webcam.chatsfree.net/RtmpPlayer.swf", "flash_webcham_subs", "100%", "100%", "9.0.0", null, flashVars, params);				
	            $("#webcam_subscriber_container").dialog({
				     dialogClass: "no-close",	
				     title: nick + " webcam",
				     close: closeWebcam,	    
				     open: function( event, ui ) {
				     	window.eventBus.trigger("webcam_sub:on");
				     	$("#webcam_subscriber_container").css("overflow", "hidden");
				     	$("#webcam_subscriber_container").css("width", "100%");
				     }
				});

			}

			function closeWebcam(){
				$("#webcam_subscriber_container").dialog('close');
				$("#webcam_subscriber_container").remove();
				window.eventBus.trigger("webcam_sub:off");
				active = false;
			}



			$(document).on('click', '.webcam_nick_subscriber', function(event) {
	    		event.preventDefault();
	    		event.stopPropagation();


		    	var nick = $(this).data("nick"); 
		    	

		    	if(active){
		    		closeWebcam();	
		    		openWebcam(nick);
		    	} else {
		    		openWebcam(nick);
		    	}

		    	

		    	return false;
			 });



		});
		});
		


    });
</script>