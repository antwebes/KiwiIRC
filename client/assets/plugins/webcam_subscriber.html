<script type="text/javascript">
    
    kiwi.plugins.on('loaded', function(){


		function onJqueryUILoaded(callback){
		    if(typeof jQuery.ui == 'undefined') {
		    	var headTag = document.getElementsByTagName("head")[0];
		    	var jqlinkTag = document.createElement('link');
                jqlinkTag.rel = 'stylesheet';
                jqlinkTag.href = '//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css';

		    	if ( typeof define === "function" && define.amd ){
		    		headTag.appendChild(jqlinkTag);

		    		require(['jquery', 'https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js'], function(jq){

		    			callback(jq);
		    		});
		    		return;
		    	}

                var jqTag = document.createElement('script');
                jqTag.type = 'text/javascript';
                jqTag.src = '//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js';
                jqTag.onload = function(){
             	    callback($);
                }
            
                jqlinkTag.onload = function(){
                    headTag.appendChild(jqTag);
                }

                headTag.appendChild(jqlinkTag);
		    } else {
		        callback($);
		    }
		}

		function onSwfobjectLoaded(callback){
		    if(typeof swfobject == 'undefined') {
                var headTag = document.getElementsByTagName("head")[0];
				var jqTag = document.createElement('script');
				jqTag.type = 'text/javascript';
				jqTag.src = '//ajax.googleapis.com/ajax/libs/swfobject/2.2/swfobject.js';
				jqTag.onload = callback;
				headTag.appendChild(jqTag);
		    } else {
				callback();
		    }
		}


		onSwfobjectLoaded(function () {
		onJqueryUILoaded(function ($) {

			

			var $webcam;
			var active = false;

			function openWebcam(nick){
				var $webcamContainer = $("#webcam_container");
				active = true;
				var params = {};
	            var flashVars = {
	                streamer: kiwi.settings.get('videochat_streamer_url')
	            };

	            flashVars.file = nick;
	            
	            params.allowfullscreen = "true";

	            //exist div to insert webcam
				if($webcamContainer.length > 0){
					$("#webcam_container").append($("<div />", {id: "webcam_subscriber_container", style: "width: 100%"}));
					//insert Modal title of bootstrap to can close the webcam subscriber
					$("#webcam_subscriber_container").append('<div class="modal-header"><button type="button" class="close" data-dismiss="modal" data-webcam="close"><span aria-hidden="true">Ã—</span><span class="sr-only" >Close</span></button><h4 class="modal-title">Webcam of '+nick+'</h4></div>');
					$("#webcam_subscriber_container").append($("<div />", {id: "flash_webcham_subs"}));

                    swfobject.embedSWF(kiwi.settings.get('videochat_subscriber_url'), "flash_webcham_subs", Math.ceil($("#webcam_subscriber_container").width())+'px', "100%", "9.0.0", null, flashVars, params);

		            $(window).resize(function() {
                        $("#flash_webcham_subs").width(Math.ceil($("#webcam_subscriber_container").width())+'px');
                    });
                //no exist div to insert webcam
	        	}else{
	        		$('body').append($("<div />", {id: "webcam_subscriber_container"}));

		            swfobject.embedSWF(kiwi.settings.get('videochat_subscriber_url'), "webcam_subscriber_container", "280px", "250px", "9.0.0", null, flashVars, params);

		            $("#webcam_subscriber_container").dialog({
					     dialogClass: "no-close",	
					     title: nick + " webcam",
					     close: closeWebcam,
					     resizable: false,
					});

	        	}
				window.eventBus.trigger("webcam_sub:on");

				return;
			}

			function closeWebcam(){
				if($("#webcam_container").length == 0){
					$("#webcam_subscriber_container").dialog('close');
					$("#webcam_subscriber_container").remove();
				}else{
					$("#webcam_subscriber_container").remove();
				}

				active = false;
				
				window.eventBus.trigger("webcam_sub:off");
			}

			$(document).on('click', '[data-webcam="close"]', function() {
				closeWebcam();
			});

			$(document).on('click', '.webcam_nick_subscriber', function(event) {
	    		event.preventDefault();
	    		event.stopPropagation();


		    	var nick = $(this).data("nick"); 
		    	
		    	if(active){
		    		closeWebcam();	
		    		openWebcam(nick);
		    	} else {
		    		openWebcam(nick);
		    	}

		    	

		    	return false;
			 });



		});
		});
		


    });
</script>