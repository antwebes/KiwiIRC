<script type="text/javascript"> 
    kiwi.plugins.on('loaded', function(){

    	function onJqueryUILoaded(callback){
		     if(typeof jQuery.ui == 'undefined') {
		                 var headTag = document.getElementsByTagName("head")[0];
		                 var jqTag = document.createElement('script');
		                 jqTag.type = 'text/javascript';
		                 jqTag.src = '//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js';
		                 jqTag.onload = callback;
		                var jqlinkTag = document.createElement('link');
		                jqlinkTag.rel = 'stylesheet';
		                jqlinkTag.href = '//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css';
		                jqlinkTag.onload = function(){
		                    headTag.appendChild(jqTag);
		                }
		                headTag.appendChild(jqlinkTag);
		     } else {
		                 callback();
		     }
		}
		
		function getActiveWebcams(channel){

			var userMediaUrl = window.window.user_media_url;
			$.ajax({
				url: userMediaUrl,
				cache: false,
				dataType: 'json'
			})
			.done(function( data ){
				updateMedia(data);
			});
			
		}

		onJqueryUILoaded(function(){
			$(document).tooltip({
				items: ".memberlists a",
				position: { my: "left+15 center", at: "right center" },
				tooltipClass: 'user-tooltip',
				content: function(){
					var nick = $.trim($( this ).text());
					if (nick.indexOf("@") != -1 || nick.indexOf("+") != -1) nick = nick.slice(1);

					return '<i class="fa fa-' + $(this).data("gender") + '"></i> ' + nick;
				}
			});
		});

		function updateMedia(data) {
			$( ".memberlists a .webcam_nick_subscriber, .memberlists a .usericon, .memberlists a .gendericon").remove();

			$( ".memberlists a" ).each(function( index ) {

				var nick = $.trim($( this ).text());
				if (nick.indexOf("@") != -1 || nick.indexOf("+") != -1) nick = nick.slice(1);

				if(data.users[nick] != undefined && data.users[nick].webcam) {
					$( this ).append('<i class="fa fa-video-camera webcam_nick_subscriber" data-nick="'+nick+'"></i> ');
				}else{
					return;
				}

				if(typeof data.users[nick].profile != undefined && typeof data.users[nick].profile.profile_photo != undefined && typeof data.users[nick].profile.profile_photo.icon != undefined){
					$( this ).prepend('<img width="16" height="16" class="usericon" src="' + data.users[nick].profile.profile_photo.icon + '">');
				}

				if(typeof data.users[nick].profile != undefined && typeof data.users[nick].profile.gender != undefined){
					var gender = data.users[nick].profile.gender;

					$(this).data('gender', gender);
				}
			});
		}

		function getMedia(){
			var activePannel = kiwi.panels().active;

			if(activePannel.isChannel()){
				getActiveWebcams(activePannel.get('name'));
			}
		}

		setInterval(getMedia, 30000);
		setTimeout(getMedia, 5000);

    });
</script>