<script type="text/javascript"> 
    kiwi.plugins.on('loaded', function(){

    	function onJqueryUILoaded(callback){
		    if(typeof jQuery.ui == 'undefined') {
		    	var headTag = document.getElementsByTagName("head")[0];
		    	var jqlinkTag = document.createElement('link');
                jqlinkTag.rel = 'stylesheet';
                jqlinkTag.href = '//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/themes/smoothness/jquery-ui.css';

		    	if ( typeof define === "function" && define.amd ){
		    		headTag.appendChild(jqlinkTag);

		    		require(['jquery', 'http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js'], function(jq){

		    			callback(jq);
		    		});
		    		return;
		    	}

                var jqTag = document.createElement('script');
                jqTag.type = 'text/javascript';
                jqTag.src = '//ajax.googleapis.com/ajax/libs/jqueryui/1.11.1/jquery-ui.min.js';
                jqTag.onload = function(){
             	    callback($);
                }
            
                jqlinkTag.onload = function(){
                    headTag.appendChild(jqTag);
                }

                headTag.appendChild(jqlinkTag);
		     } else {
		        callback($);
		     }
		}
		
		function getActiveWebcams(channel){

			var userMediaUrl = window.window.user_media_url;
			$.ajax({
				url: userMediaUrl,
				cache: false,
				dataType: 'json'
			})
			.done(function( data ){
				updateMedia(data);
			});
			
		}

		var userData = {};

		function calculateAge(birthday){
			var currentYear = new Date().getFullYear();
        	var yearUser = new Date(birthday).getFullYear().toString().substring(0,4);
        	var yearsOld = currentYear - yearUser;
	        
	        if(yearsOld <=0){
	            yearsOld = '>18';
	        }else if(isNaN(yearsOld)){
	            yearsOld = '';
	        }

	        return yearsOld;
		}

		onJqueryUILoaded(function($){
			$(document).tooltip({
				items: ".memberlists a",
				position: { my: "left+15 center", at: "right center" },
				tooltipClass: 'user-tooltip',
				content: function(){
					var nick = $.trim($( this ).text());
					var country = '';
					var age = '';
					var gender = '';

					if (nick.indexOf("@") != -1 || nick.indexOf("+") != -1) nick = nick.slice(1);

					if(typeof(userData[nick]) !== 'undefined' && typeof(userData[nick].profile) !== 'undefined' && typeof(userData[nick].profile.gender) !== 'undefined'){
						gender = '<i class="fa fa-' + userData[nick].profile.gender + '"></i> ';
					}

					if(typeof(userData[nick]) !== 'undefined' && typeof(userData[nick].country) !== 'undefined'){
						country = '&nbsp;<span class="tooltip-country">' + userData[nick].country + '</span>';
					}

					if(typeof(userData[nick]) !== 'undefined' && typeof(userData[nick].profile) !== 'undefined' && typeof(userData[nick].profile.birthday)){
						age = '&nbsp;<span class="tooltip-age">' + calculateAge(userData[nick].profile.birthday) + '</span>';
					}

					return gender + age + country;
				}
			});
		});

		function updateMembersList(){
			console.log('updateMedia');
			console.log(userData);
			$( ".memberlists a .webcam_nick_subscriber, .memberlists a .usericon, .memberlists a .gendericon").remove();

			$( ".memberlists a" ).each(function( index ) {

				var nick = $.trim($( this ).text());
				if (nick.indexOf("@") != -1 || nick.indexOf("+") != -1) nick = nick.slice(1);

				if(userData[nick] != undefined && userData[nick].webcam) {
					$( this ).append('<i class="fa fa-video-camera webcam_nick_subscriber" data-nick="'+nick+'"></i> ');
				}else{
					return;
				}

				if(typeof userData[nick].profile != 'undefined' && typeof userData[nick].profile.profile_photo != 'undefined' && typeof userData[nick].profile.profile_photo.icon != 'undefined'){
					$( this ).prepend('<img width="16" height="16" class="usericon" src="' + userData[nick].profile.profile_photo.icon + '">');
				}
			});
		}

		function updateMedia(data) {
			userData = data.users;

			updateMembersList();
		}

		kiwi.panels.on('active', function(){
			setTimeout(updateMembersList, 100);
		});

		function getMedia(){
			var activePannel = kiwi.panels().active;

			if(activePannel.isChannel()){
				getActiveWebcams(activePannel.get('name'));
			}
		}

		setInterval(getMedia, 30000);
		setTimeout(getMedia, 5000);

    });
</script>