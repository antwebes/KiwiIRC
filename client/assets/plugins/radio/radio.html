<script>
(function () {

		window.radio = {};

        function start(radio) {
        	$("body").append('<div id="jquery_jplayer_1" style="display: none;">');

        	$.getScript(window.kiwi_server + "/kiwi/assets/plugins/radio/jquery.jplayer.js", function( data, textStatus, jqxhr ) {
					var stream = {
						title: radio.name,
						mp3: radio.url
					},
					ready = false;

					$("#jquery_jplayer_1").jPlayer({
						ready: function (event) {
							ready = true;
							$(this).jPlayer("setMedia", stream);
							$(this).jPlayer("play");
							if(radio.channel) {
								var input = kiwi.components.ControlInput()
                				input.run("/join " + radio.channel);
							}
						},
						pause: function() {
							$(this).jPlayer("clearMedia");
						},
						error: function(event) {
							if(ready && event.jPlayer.error.type === $.jPlayer.error.URL_NOT_SET) {
								// Setup the media stream again and play it.
								$(this).jPlayer("setMedia", stream).jPlayer("play");
							}
						},
						swfPath: "/kiwi/assets/plugins/radio/",
						supplied: "mp3",
						preload: "none",
						wmode: "window",
						useStateClassSkin: true,
						autoBlur: false,
						keyEnabled: true
					});
			});
	    };

	function changeVolume(volume) {
		$("#jquery_jplayer_1").jPlayer("volume", volume);
	}

	function play(radio) {
		var stream = {
			title: radio.name,
			mp3: radio.url
		};

		if(radio.channel) {
			var input = kiwi.components.ControlInput()
			input.run("/join " + radio.channel);
		}

		$("#jquery_jplayer_1").jPlayer("setMedia", stream);
		$("#jquery_jplayer_1").jPlayer("play");
	}

	function stop() {
		$("#jquery_jplayer_1").jPlayer("stop");
	}

	function findRadioById(id) {
		var radio = kiwi.settings.get("radio");
		var numRadios = radio.length;
		for(var i=0; i<numRadios; i++) {
			console.log(radio[i]);
			if(radio[i].id == id) return radio[i];
     	}  
     	return null;
	}

	function buildMenuRadio() {
 			var radioMenu = [];
 			var radio = kiwi.settings.get("radio");
 			var numRadios = radio.length;


 				radioMenu.push({
 					"name": "Volume", 
 					"icon": "volume-up", 
 					"type": "Slider", 
 					"options": {"defaultValue": window.radio.volume || 100, "event": "slidechange"}, 
 					"command": "/radiovolume"
 				});

     			for(var i=0; i<numRadios; i++) {
     				radioMenu.push({
     					"name": radio[i].name, 
     					"icon": "headphones", 
     					"type": "Toggle", 
     					"options": {"defaultValue": false, "groupName": "radios"}, 
     					"command": "/playradio " +radio[i].id 
     				});
     			}    			

  			 	     		

 			var menuItemsLengt = window.right_menu_items.length;
			for (var i=0 ; i < menuItemsLengt ; i++)
			{
			    if (window.right_menu_items[i].name == "Radio") {
			        window.right_menu_items[i].submenu = radioMenu;
			    }
			}   
	};

   $( ".right-menu" ).promise().done(function() {
    	buildMenuRadio();
    });
   

    var started = false;
    kiwi.events.on('command', function(event, data) {
        if (data.command === 'playradio') {
        	var radio = findRadioById(data.params[0]);
        	window.radio.selected = radio.id;

        	if(!started) {
        		start(radio);
        		started = true;
        		
        	} else {
        		if(data.params[1] == "true") {
        			play(radio);
	        	} else {
	        		stop();
	        		window.radio.selected = 0;
	        	}
        	}         
        }
        if (data.command === 'radiovolume') {
        	changeVolume(data.params[0]);
        }
    });


})();
</script>