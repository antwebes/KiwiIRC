<script type="text/javascript">

//get param of url
function getQueryVariable(variable)
{
       var query = window.location.search.substring(1);
       var vars = query.split("&");
       for (var i=0;i<vars.length;i++) {
               var pair = vars[i].split("=");
               if(pair[0] == variable){return pair[1];}
       }
       return(false);
}

function quitParamCodeOfUrl()
{
	var url = window.location.href;
	
	//cogemos lo que hay desde el último &
	var output = url.split('&').pop();
	//se lo quitamos a toda la url
	var redirect = url.replace(output,'');

	//quitamos el último caracter que es el &
	redirect = redirect.slice(0,-1);

	//codificamos la url, cambiamos el & por el %26, la g es para que cambie todas las ocurrencias de &
	redirect = redirect.replace(/&/g , '%26');
	return redirect;
}

function autoCompleteFormKiwi()
{
	//fill field username
	$('#server_select_nick').val(window.username);
	if(getQueryVariable('channel')){
        var channels = getQueryVariable('channel').split(',');
        channels = channels.map(function(channel){
            return '#'+channel;
        });
        //fill field channel
        $('#server_select_channel').val(channels.join(','));
        //clickamos in the form to access to chat
        $('form button').click();
	}
}

var api_endpoint = getQueryVariable("api_endpoint");
var client_id = getQueryVariable("client_id");
var secret = getQueryVariable("secret");
var code = getQueryVariable("code");
var redirect_uri = quitParamCodeOfUrl();


// Event fired after all plugins are loaded and Kiwi is ready
kiwi.plugins.on('loaded', function() {

	if (client_id){
	    $.ajax({
		    type: "GET",
		    dataType: 'json',
		    url: api_endpoint+"oauth/v2/token?client_id="+client_id+"&client_secret="+secret+"&grant_type=authorization_code&redirect_uri="+redirect_uri+"&code="+code,
		    success : function(data){
		    	window.username = data.username;
				window.token = data.access_token;
				var msg = {
					'token' : data.access_token
				};
				parent.postMessage(msg, '*');
				autoCompleteFormKiwi();
		    },
		    error: function(XMLHttpRequest, textStatus, errorThrown){
				alert('no se ha podido recuperar el token de usuario');
				console.log(XMLHttpRequest);
		        console.log(textStatus);
		        console.log(errorThrown);
		    }
	  	});
	}else{
		if(getQueryVariable('channel')){
            var channels = getQueryVariable('channel').split(',');
            channels = channels.map(function(channel){
                return '#'+channel;
            });
            
            $('#server_select_channel').val(channels.join(','));
        }
	}
});

</script>