<script type="text/javascript"> 
 
     (function() {
		kiwi.events.on('loaded', function () {
			var historialItem = kiwi.i18n.translate('plugin_right_menu_history').fetch();
			var chatInput = kiwi.components.ControlInput();

			function supports_html5_storage() {
				try {
					return 'localStorage' in window && window['localStorage'] !== null;
				} catch (e) {
					return false;
				}
			}

			function getChannelHistoryStatus() {
				var enableHistory = JSON.parse(localStorage.getItem('channel_history_enabled'));
				if (enableHistory == null) {
					localStorage.setItem("channel_history_enabled", true);
					enableHistory = true;
				}
				return enableHistory;
			}

			function buildMenuHistory() {
				var channelsMenu = [];
				var enableHistory = getChannelHistoryStatus();
				channelsMenu.push({
					"name": 'Enable History',
					"type": "Toggle",
					"options": {"defaultValue": enableHistory},
					"icon": "trash",
					"command": "/togglehistory"
				});

				var channels = JSON.parse(localStorage.getItem('channel_history')) || [];
				channels.reverse();

				if(typeof channels.length == 'undefined'){
					var numChannels = 0;
				}else {
					var numChannels = channels.length;
				}

				if (numChannels > 0) {

					//Item delete history
					channelsMenu.push({"name": "Clear History", "icon": "trash", "command": "/clearhistory"});


					for (var i = 0; i < numChannels; i++) {
						channelsMenu.push({"name": channels[i], "icon": "comments", "command": "/join " + channels[i]});
					}

				}

				if(typeof window.right_menu_items == 'undefined' || typeof window.right_menu_items.length == 'undefined'){
					var menuItemsLengt = 0;
				}else {
					var menuItemsLengt = window.right_menu_items.length;
				}

				for (var i = 0; i < menuItemsLengt; i++) {
					if(window.right_menu_items[i].name == historialItem){
						window.right_menu_items[i].submenu = channelsMenu;
					}
				}
			}

			if (supports_html5_storage()) {

				var network = kiwi.components.Network();

				kiwi.events.on('command', function (event, data) {
					if (data.command === 'clearhistory') {
						localStorage.removeItem("channel_history");
					}
					if (data.command === 'togglehistory') {
						var historyStatus = getChannelHistoryStatus();
						if (typeof ga !== 'undefined') ga('send', 'event', 'right_menu', "enable_history", !historyStatus);
						localStorage.setItem("channel_history_enabled", !historyStatus);

					}

				});


				network.on('channel:join', function (event) {
					var enableHistory = JSON.parse(localStorage.getItem('channel_history_enabled'));
					var channels = JSON.parse(localStorage.getItem('channel_history')) || [];

					if (enableHistory) {
						var channel = event.channel.toLowerCase();
						var enableHistory = getChannelHistoryStatus();
						if (channels.indexOf(channel) == -1) {
							var $historyItem = $('<li><span><i class="fa fa-comments"></i> ' + channel + '</span></li>');
							var $historySubtitle = $('.mm-subtitle:contains("' + historialItem + '")').parent();
							var $historyCounter = $('.right-menu-items > li:contains("' + historialItem + '") .mm-counter');

							channels.push(channel);

							$historyItem.on("click", function(){
								chatInput.run('/join ' + channel);

								$('.right-menu').mmenu().trigger("close.mm");
							});


							$historySubtitle
								.append($historyItem)
								.show();

							var count = parseInt($historyCounter.html()) + 1;
							$historyCounter.html(count);
						}

						localStorage.setItem("channel_history", JSON.stringify(channels));
					}
				});
			}

			window.menu_items_ready_promise.promise().done(function(){
				buildMenuHistory();
			});
		});
    })();
</script>	